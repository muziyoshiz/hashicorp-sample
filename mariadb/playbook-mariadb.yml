- name: Sample MariaDB Server
  hosts: all
  sudo: yes
  tasks:
    # Change timezone
    - name: Change timezone from UTC to JST
      command: cp -p /usr/share/zoneinfo/Japan /etc/localtime
    # Add repository for yum
    - name: Add repository 'remi-repo'
      yum: name=http://rpms.famillecollet.com/enterprise/remi-release-7.rpm state=present
    # Install MariaDB
    - name: Install MariaDB
      yum: name="{{ item }}" state=present
      with_items:
        - mariadb
        - mariadb-server
        - MySQL-python # required by mysql_db and mysql_user module
    - name: Start MariaDB and create autostart setting
      service: name=mariadb state=started enabled=yes
    # Set root account
    - name: Set root account of MariaDB
      mysql_user:
        name: root
        password: "dummy password"
        host: localhost
    # Create .my.cnf for creating database
    - name: Create /root/.my.cnf
      template: src=templates/mariadb/my.cnf dest="/root/.my.cnf" mode=0600
    # Create database "sample"
    - name: Create database "sample"
      mysql_db: name=sample state=present
    # Create "manager" account of MariaDB and grant all plivileges of sample database
    - name: Create "manager" account of MariaDB
      mysql_user:
        name: manager
        password: "dummy mgr password"
        priv: "sample.*:ALL"
        host: 192.168.33.10
        state: present
    # Install packages
    - name: Install unzip for Consul package
      yum: name=unzip state=present
    # Install Consul
    - name: Check if consul is installed
      stat: path=/usr/local/bin/consul
      register: consul_bin
    - name: Download Consul package
      get_url: url=https://releases.hashicorp.com/consul/0.5.2/consul_0.5.2_linux_amd64.zip dest=/home/vagrant/consul.zip
      when: not consul_bin.stat.exists
    - name: Unzip Consul package
      command: unzip consul.zip
      args:
        chdir: /home/vagrant/
      when: not consul_bin.stat.exists
    - name: Remove Consul package
      command: rm /home/vagrant/consul.zip
      when: not consul_bin.stat.exists
    - name: Add execution permission to consul command
      file: path=/home/vagrant/consul state=file mode="0755"
      when: not consul_bin.stat.exists
    - name: Move consul command
      command: mv /home/vagrant/consul /usr/local/bin/consul
      when: not consul_bin.stat.exists
    # Create Consul server settings
    - name: Create sysconfig file for environments
      template: src="templates/consul/consul" dest="/etc/sysconfig/consul" owner=root group=root mode=0644
    - name: Create consul setting directory
      file: path=/etc/consul.d state=directory owner=root group=root mode=0755
    - name: Create common consul setting
      template: src="templates/consul/consul.service" dest="/etc/systemd/system/consul.service" owner=root group=root mode=0644
    - name: Call daemon-reload explicitly because service module does not call it
      command: systemctl daemon-reload
    # MariaDB-specific setting
    - name: Create mariadb service information for consul
      template: src="templates/consul/mariadb.json" dest="/etc/consul.d/mariadb.json" owner=root group=root mode=0644
    # Common task
    - name: Start consul and create autostart setting
      service: name=consul state=restarted enabled=yes
    # Install dnsmasq
    - name: Install dnsmasq
      yum: name=dnsmasq state=present
    - name: Create dnsmasq setting
      template: src="templates/dnsmasq/dnsmasq.conf" dest="/etc/dnsmasq.conf" owner=root group=root mode=0644
    - name: Start dnsmasq and create autostart setting
      service: name=dnsmasq state=restarted enabled=yes
    - name: Replace /etc/resolv.conf that includes localhost as nameserver
      template: src="templates/dnsmasq/resolv.conf" dest="/etc/resolv.conf" owner=root group=root mode=0644
    - name: Forbid NetworkManager from overwriting /etc/resolv.conf
      lineinfile: dest=/etc/NetworkManager/NetworkManager.conf line="dns=none"
